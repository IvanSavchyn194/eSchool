pipeline{
    agent any
    stages{
   
        stage('compile'){
         environment {
      DATASOURCE_USERNAME = credentials('DATASOURCE_USERNAME')
      DATASOURCE_PASSWORD = credentials('DATASOURCE_PASSWORD')
   }
            steps{
                    sh 'mvn clean compile'
            }
        }
        stage('test'){
         environment {
      DATASOURCE_USERNAME = credentials('DATASOURCE_USERNAME')
      DATASOURCE_PASSWORD = credentials('DATASOURCE_PASSWORD')
   }
            steps{
                    sh 'mvn test -Dtest=!academy.softserve.eschool.*.*IntegrationTest'
            }
        }
        stage("Build"){
         environment {
      DATASOURCE_USERNAME = credentials('DATASOURCE_USERNAME')
      DATASOURCE_PASSWORD = credentials('DATASOURCE_PASSWORD')
   }
            steps{
                    sh "echo spring.datasource.username=${env.DATASOURCE_USERNAME} >> application.property"
                    sh "echo spring.datasource.password=${env.DATASOURCE_PASSWORD} >> application.property"
                    sh 'mvn package -Dmaven.test.skip=true'
            }
        }
        stage("Deploy"){
         environment {
      DATASOURCE_USERNAME = credentials('DATASOURCE_USERNAME')
      DATASOURCE_PASSWORD = credentials('DATASOURCE_PASSWORD')
   }
            steps{
                 sshPublisher(publishers: 
                 [sshPublisherDesc(configName: 'eSchool_prod', 
                 transfers: 
                 [sshTransfer(cleanRemote: false, excludes: '', 
                 execCommand: '''sudo systemctl stop eSchool.service | mv /home/azureuser/eSchool/eschool.jar /home/azureuser/eSchool/eSchool_bec/eschool_${BUILD_ID}_$(date +"%F_%T").jar''', 
                  execTimeout: 120000,
                  ), 
                  sshTransfer(cleanRemote: false, excludes: '', 
                  execCommand: 'sudo systemctl start eSchool.service', 
                  execTimeout: 120000, 
                  removePrefix: 'target', 
                  sourceFiles: 'target/*.jar')], 
                  )
                  ])
                    }
        }
    }
}
